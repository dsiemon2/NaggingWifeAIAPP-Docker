<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wife's Wishlist - Nagging Wife AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; max-height: 100vh; overflow-y: auto; background: #1e3a5f; position: sticky; top: 0; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .bulk-actions { display: none; background: #e3f2fd; padding: 0.75rem 1rem; border-radius: 8px; align-items: center; gap: 0.5rem; }
    .bulk-actions.show { display: flex; }
    .row-checkbox { cursor: pointer; width: 18px; height: 18px; }
    tr.selected { background-color: #cfe2ff !important; }
    tr.selected td { background-color: #cfe2ff !important; }
    tbody tr:hover { background-color: #f8f9fa; }
    tbody tr.selected:hover { background-color: #b6d4fe !important; }
    .wishlist-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
    .priority-must-have { border-left: 4px solid #dc3545 !important; }
    .priority-high { border-left: 4px solid #fd7e14 !important; }
    .purchased-row { opacity: 0.6; text-decoration: line-through; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'wishlist' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-gift text-danger me-2"></i>Wife's Wishlist</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-lg"></i> Add Item
          </button>
        </div>

        <!-- Category Filter -->
        <div class="mb-4">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" onclick="filterCategory('all')">All</button>
            <button type="button" class="btn btn-outline-primary" onclick="filterCategory('jewelry')"><i class="bi bi-gem"></i> Jewelry</button>
            <button type="button" class="btn btn-outline-primary" onclick="filterCategory('clothing')"><i class="bi bi-bag"></i> Clothing</button>
            <button type="button" class="btn btn-outline-primary" onclick="filterCategory('electronics')"><i class="bi bi-phone"></i> Electronics</button>
            <button type="button" class="btn btn-outline-primary" onclick="filterCategory('home')"><i class="bi bi-house"></i> Home</button>
            <button type="button" class="btn btn-outline-primary" onclick="filterCategory('experiences')"><i class="bi bi-star"></i> Experiences</button>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-danger text-white">
              <div class="card-body">
                <h6><i class="bi bi-exclamation-circle"></i> Must-Have</h6>
                <h3 class="mb-0"><%= mustHaveCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-dark">
              <div class="card-body">
                <h6><i class="bi bi-arrow-up"></i> High Priority</h6>
                <h3 class="mb-0"><%= highPriorityCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body">
                <h6><i class="bi bi-check-circle"></i> Purchased</h6>
                <h3 class="mb-0"><%= purchasedCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body">
                <h6><i class="bi bi-list-ul"></i> Total Items</h6>
                <h3 class="mb-0"><%= totalItems || 0 %></h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions mb-3" id="bulkActions">
          <span class="me-3"><strong id="selectedCount">0</strong> selected</span>
          <button class="btn btn-sm btn-outline-success me-2" onclick="markPurchased()" data-bs-toggle="tooltip" title="Mark as purchased">
            <i class="bi bi-check-circle"></i> Mark Purchased
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()" data-bs-toggle="tooltip" title="Delete selected items">
            <i class="bi bi-trash"></i> Delete Selected
          </button>
        </div>

        <div class="card">
          <div class="card-body p-0">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="selectAll" data-bs-toggle="tooltip" title="Select all">
                  </th>
                  <th style="width: 60px;">Image</th>
                  <th>Item</th>
                  <th>Category</th>
                  <th>Priority</th>
                  <th>Price Range</th>
                  <th>Occasion</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <% if (items && items.length > 0) { %>
                  <% items.forEach(item => { %>
                  <tr class="<%= item.priority === 'must-have' ? 'priority-must-have' : item.priority === 'high' ? 'priority-high' : '' %> <%= item.isPurchased ? 'purchased-row' : '' %>">
                    <td><input type="checkbox" class="form-check-input row-checkbox" data-id="<%= item.id %>"></td>
                    <td>
                      <% if (item.imageUrl) { %>
                        <img src="<%= item.imageUrl %>" alt="<%= item.name %>" class="wishlist-img">
                      <% } else { %>
                        <div class="wishlist-img bg-light d-flex align-items-center justify-content-center">
                          <i class="bi bi-gift text-muted"></i>
                        </div>
                      <% } %>
                    </td>
                    <td>
                      <strong><%= item.name %></strong>
                      <% if (item.productUrl) { %>
                        <a href="<%= item.productUrl %>" target="_blank" class="ms-1" data-bs-toggle="tooltip" title="View product"><i class="bi bi-box-arrow-up-right"></i></a>
                      <% } %>
                      <% if (item.description) { %>
                        <br><small class="text-muted"><%= item.description.substring(0, 50) %><%= item.description.length > 50 ? '...' : '' %></small>
                      <% } %>
                    </td>
                    <td>
                      <span class="badge bg-secondary">
                        <i class="bi bi-<%= item.category === 'jewelry' ? 'gem' : item.category === 'clothing' ? 'bag' : item.category === 'electronics' ? 'phone' : item.category === 'home' ? 'house' : item.category === 'experiences' ? 'star' : 'tag' %>"></i>
                        <%= item.category.charAt(0).toUpperCase() + item.category.slice(1) %>
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-<%= item.priority === 'must-have' ? 'danger' : item.priority === 'high' ? 'warning text-dark' : item.priority === 'low' ? 'secondary' : 'info' %>">
                        <%= item.priority.charAt(0).toUpperCase() + item.priority.slice(1) %>
                      </span>
                    </td>
                    <td><%= item.priceRange || '-' %></td>
                    <td>
                      <% if (item.occasion) { %>
                        <span class="badge bg-light text-dark"><%= item.occasion %></span>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td>
                      <% if (item.isPurchased) { %>
                        <span class="badge bg-success"><i class="bi bi-check"></i> Purchased</span>
                      <% } else { %>
                        <span class="badge bg-outline-secondary text-secondary">Pending</span>
                      <% } %>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick="editItem('<%= item.id %>')" data-bs-toggle="tooltip" title="Edit item">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <% if (!item.isPurchased) { %>
                      <button class="btn btn-sm btn-outline-success" onclick="orderGift('<%= item.id %>')" data-bs-toggle="tooltip" title="Order this gift">
                        <i class="bi bi-cart-plus"></i>
                      </button>
                      <% } %>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('<%= item.id %>')" data-bs-toggle="tooltip" title="Delete item">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <% }) %>
                <% } else { %>
                <tr>
                  <td colspan="9" class="text-center py-5">
                    <i class="bi bi-gift text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No Wishlist Items Yet</h5>
                    <p class="text-muted">Add items your wife wants to never forget gift ideas!</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                      <i class="bi bi-plus-lg"></i> Add First Item
                    </button>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div class="text-muted small">Showing <span id="showingStart">1</span>-<span id="showingEnd"><%= items?.length || 0 %></span> of <span id="totalRows"><%= items?.length || 0 %></span></div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
            <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
              <option value="10">10 / page</option>
              <option value="25">25 / page</option>
              <option value="50">50 / page</option>
            </select>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Item Modal -->
  <div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gift me-2"></i>Add Wishlist Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addItemForm">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-8 mb-3">
                <label class="form-label">Item Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="name" placeholder="e.g., Diamond Earrings" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="category">
                  <option value="general">General</option>
                  <option value="jewelry">Jewelry</option>
                  <option value="clothing">Clothing</option>
                  <option value="electronics">Electronics</option>
                  <option value="home">Home & Garden</option>
                  <option value="experiences">Experiences</option>
                  <option value="beauty">Beauty & Spa</option>
                  <option value="books">Books & Media</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority">
                  <option value="low">Low</option>
                  <option value="normal" selected>Normal</option>
                  <option value="high">High</option>
                  <option value="must-have">Must-Have</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Price Range</label>
                <input type="text" class="form-control" name="priceRange" placeholder="e.g., $50-100">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">For Occasion</label>
                <select class="form-select" name="occasion">
                  <option value="">Any Occasion</option>
                  <option value="birthday">Birthday</option>
                  <option value="christmas">Christmas</option>
                  <option value="anniversary">Anniversary</option>
                  <option value="valentines">Valentine's Day</option>
                  <option value="mothers-day">Mother's Day</option>
                  <option value="just-because">Just Because</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Product URL</label>
              <input type="url" class="form-control" name="productUrl" placeholder="https://...">
            </div>
            <div class="mb-3">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-control" name="imageUrl" placeholder="https://...">
            </div>
            <div class="mb-3">
              <label class="form-label">Description / Notes</label>
              <textarea class="form-control" name="description" rows="2" placeholder="Size, color preferences, etc."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Save Item</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Item Modal -->
  <div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Wishlist Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editItemForm">
          <input type="hidden" name="id" id="editItemId">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-8 mb-3">
                <label class="form-label">Item Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="name" id="editName" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="category" id="editCategory">
                  <option value="general">General</option>
                  <option value="jewelry">Jewelry</option>
                  <option value="clothing">Clothing</option>
                  <option value="electronics">Electronics</option>
                  <option value="home">Home & Garden</option>
                  <option value="experiences">Experiences</option>
                  <option value="beauty">Beauty & Spa</option>
                  <option value="books">Books & Media</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority" id="editPriority">
                  <option value="low">Low</option>
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="must-have">Must-Have</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Price Range</label>
                <input type="text" class="form-control" name="priceRange" id="editPriceRange">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">For Occasion</label>
                <select class="form-select" name="occasion" id="editOccasion">
                  <option value="">Any Occasion</option>
                  <option value="birthday">Birthday</option>
                  <option value="christmas">Christmas</option>
                  <option value="anniversary">Anniversary</option>
                  <option value="valentines">Valentine's Day</option>
                  <option value="mothers-day">Mother's Day</option>
                  <option value="just-because">Just Because</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Product URL</label>
              <input type="url" class="form-control" name="productUrl" id="editProductUrl">
            </div>
            <div class="mb-3">
              <label class="form-label">Description / Notes</label>
              <textarea class="form-control" name="description" id="editDescription" rows="2"></textarea>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="isPurchased" id="editIsPurchased">
              <label class="form-check-label" for="editIsPurchased">Mark as Purchased</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Update Item</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <%- include('_table-controls') %>
  <script>
    const token = '<%= token %>';
    const basePath = '<%= typeof _basePath !== "undefined" ? _basePath : "/NaggingWife" %>';
    let tableControls;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize table controls with pagination and selection
      tableControls = new TableControls();

      document.getElementById('addItemForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
          const res = await fetch(`${basePath}/admin/wishlist?token=${token}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            location.reload();
          } else {
            alert('Failed to save item');
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });

      document.getElementById('editItemForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editItemId').value;
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.isPurchased = document.getElementById('editIsPurchased').checked;

        try {
          const res = await fetch(`${basePath}/admin/wishlist/${id}?token=${token}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            location.reload();
          } else {
            alert('Failed to update item');
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });
    });

    function getSelectedIds() {
      return tableControls ? tableControls.getSelectedIds() : [];
    }

    function filterCategory(cat) {
      window.location.href = `${basePath}/admin/wishlist?token=${token}&category=${cat}`;
    }

    async function markPurchased() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;

      try {
        const res = await fetch(`${basePath}/admin/wishlist/mark-purchased?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if (res.ok) location.reload();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteSelected() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      if (!confirm(`Delete ${ids.length} item(s)?`)) return;

      try {
        const res = await fetch(`${basePath}/admin/wishlist/bulk-delete?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if (res.ok) location.reload();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteItem(id) {
      if (!confirm('Delete this item?')) return;
      try {
        const res = await fetch(`${basePath}/admin/wishlist/${id}?token=${token}`, { method: 'DELETE' });
        if (res.ok) location.reload();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function editItem(id) {
      try {
        const res = await fetch(`${basePath}/admin/wishlist/${id}/edit?token=${token}`);
        const data = await res.json();
        if (data.success && data.item) {
          const i = data.item;
          document.getElementById('editItemId').value = i.id;
          document.getElementById('editName').value = i.name || '';
          document.getElementById('editCategory').value = i.category || 'general';
          document.getElementById('editPriority').value = i.priority || 'normal';
          document.getElementById('editPriceRange').value = i.priceRange || '';
          document.getElementById('editOccasion').value = i.occasion || '';
          document.getElementById('editProductUrl').value = i.productUrl || '';
          document.getElementById('editDescription').value = i.description || '';
          document.getElementById('editIsPurchased').checked = i.isPurchased || false;
          new bootstrap.Modal(document.getElementById('editItemModal')).show();
        } else {
          alert('Failed to load item');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function orderGift(id) {
      window.location.href = `${basePath}/admin/gift-orders/new?wishlistItemId=${id}&token=${token}`;
    }
  </script>
</body>
</html>
