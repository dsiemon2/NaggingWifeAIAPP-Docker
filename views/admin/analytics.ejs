<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - Nagging Wife AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar { min-height: 100vh; max-height: 100vh; overflow-y: auto; background: #1e3a5f; position: sticky; top: 0; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .stat-card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; }
    .chart-container { position: relative; height: 300px; }
    .score-badge { font-size: 1rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .bulk-actions { display: none; background: #e3f2fd; padding: 0.75rem 1rem; border-radius: 8px; }
    .bulk-actions.show { display: flex; }
    .row-checkbox { cursor: pointer; width: 18px; height: 18px; }
    tr.selected { background-color: #cfe2ff !important; }
    tr.selected td { background-color: #cfe2ff !important; }
    tbody tr:hover { background-color: #f8f9fa; }
    tbody tr.selected:hover { background-color: #b6d4fe !important; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'analytics' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="mb-1"><i class="bi bi-graph-up text-primary me-2"></i>Analytics Dashboard</h2>
            <p class="text-muted mb-0">Track your performance on keeping a happy wife!</p>
          </div>
          <div>
            <select class="form-select" id="dateRange" onchange="changeDateRange(this.value)">
              <option value="7" <%= days === 7 ? 'selected' : '' %>>Last 7 days</option>
              <option value="30" <%= days === 30 ? 'selected' : '' %>>Last 30 days</option>
              <option value="90" <%= days === 90 ? 'selected' : '' %>>Last 90 days</option>
              <option value="365" <%= days === 365 ? 'selected' : '' %>>Last year</option>
            </select>
          </div>
        </div>

        <!-- Session Stats -->
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="card stat-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                    <i class="bi bi-chat-dots"></i>
                  </div>
                  <div>
                    <div class="stat-value text-primary"><%= stats.totalSessions %></div>
                    <div class="text-muted">Total Sessions</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                    <i class="bi bi-check-circle"></i>
                  </div>
                  <div>
                    <div class="stat-value text-success"><%= stats.completedSessions %></div>
                    <div class="text-muted">Completed</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                    <i class="bi bi-percent"></i>
                  </div>
                  <div>
                    <div class="stat-value text-info"><%= stats.completionRate %>%</div>
                    <div class="text-muted">Completion Rate</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                    <i class="bi bi-star"></i>
                  </div>
                  <div>
                    <div class="stat-value text-warning"><%= stats.averageScore %></div>
                    <div class="text-muted">Avg. Score</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chores & Gifts Stats -->
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="card stat-card h-100 border-start border-4 border-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-danger bg-opacity-10 text-danger me-3">
                    <i class="bi bi-exclamation-triangle"></i>
                  </div>
                  <div>
                    <div class="stat-value text-danger"><%= choreStats.overdue %></div>
                    <div class="text-muted">Overdue Chores</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card h-100 border-start border-4 border-warning">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                    <i class="bi bi-list-task"></i>
                  </div>
                  <div>
                    <div class="stat-value text-warning"><%= choreStats.pending %></div>
                    <div class="text-muted">Pending Chores</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card h-100 border-start border-4 border-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                    <i class="bi bi-gift"></i>
                  </div>
                  <div>
                    <div class="stat-value text-success"><%= giftStats.delivered %></div>
                    <div class="text-muted">Gifts Delivered</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card h-100 border-start border-4 border-info">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                    <i class="bi bi-heart"></i>
                  </div>
                  <div>
                    <div class="stat-value text-info"><%= wishlistStats.total %></div>
                    <div class="text-muted">Wishlist Items</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 mb-4">
          <!-- Status Chart -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-pie-chart me-2 text-primary"></i>Session Status</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="statusChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Chores Progress Chart -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2 text-primary"></i>Chores Progress</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="choresChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 mb-4">
          <!-- Sessions by Topic -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-tags me-2 text-primary"></i>Sessions by Topic</h5>
              </div>
              <div class="card-body">
                <% if (byTopic.length === 0) { %>
                <div class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1"></i>
                  <p class="mt-2">No session data available</p>
                </div>
                <% } else { %>
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Topic</th>
                      <th class="text-end">Sessions</th>
                      <th style="width: 40%;">Distribution</th>
                    </tr>
                  </thead>
                  <tbody id="topicTableBody">
                    <% byTopic.forEach((t, idx) => { %>
                    <tr style="cursor: pointer;">
                      <td><%= t.name %></td>
                      <td class="text-end"><%= t.count %></td>
                      <td>
                        <div class="progress" style="height: 8px;">
                          <div class="progress-bar bg-primary" role="progressbar" style="width: <%= (t.count / stats.totalSessions * 100).toFixed(0) %>%"></div>
                        </div>
                      </td>
                    </tr>
                    <% }) %>
                  </tbody>
                </table>
                <% } %>
              </div>
              <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                <div class="text-muted small">Showing <span id="topicShowingStart">1</span>-<span id="topicShowingEnd"><%= byTopic?.length || 0 %></span> of <span id="topicTotalRows"><%= byTopic?.length || 0 %></span></div>
                <nav>
                  <ul class="pagination pagination-sm mb-0" id="topicPagination"></ul>
                </nav>
                <select class="form-select form-select-sm" id="topicPageSize" style="width: auto;">
                  <option value="10">10 / page</option>
                  <option value="25">25 / page</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Top Performers -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-trophy me-2 text-warning"></i>Top Performance Sessions</h5>
                <span class="badge bg-success"><%= topPerformers.length %> high scores</span>
              </div>
              <div class="card-body p-0">
                <% if (topPerformers.length === 0) { %>
                <div class="text-center text-muted py-4">
                  <i class="bi bi-emoji-smile fs-1"></i>
                  <p class="mt-2">Complete more sessions to see top scores!</p>
                </div>
                <% } else { %>
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Score</th>
                      <th>Name</th>
                      <th>Topic</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="topPerformersBody">
                    <% topPerformers.forEach(tp => { %>
                    <tr style="cursor: pointer;">
                      <td>
                        <span class="score-badge bg-<%= tp.score >= 8 ? 'success' : 'primary' %> text-white">
                          <%= tp.score %>
                        </span>
                      </td>
                      <td><strong><%= tp.name %></strong></td>
                      <td><%= tp.topic %></td>
                      <td><%= new Date(tp.completedAt).toLocaleDateString() %></td>
                      <td>
                        <a href="/admin/sessions/<%= tp.id %>?token=<%= token %>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View session details">
                          <i class="bi bi-eye"></i>
                        </a>
                      </td>
                    </tr>
                    <% }) %>
                  </tbody>
                </table>
                <% } %>
              </div>
              <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                <div class="text-muted small">Showing <span id="performersShowingStart">1</span>-<span id="performersShowingEnd"><%= topPerformers?.length || 0 %></span> of <span id="performersTotalRows"><%= topPerformers?.length || 0 %></span></div>
                <nav>
                  <ul class="pagination pagination-sm mb-0" id="performersPagination"></ul>
                </nav>
                <select class="form-select form-select-sm" id="performersPageSize" style="width: auto;">
                  <option value="10">10 / page</option>
                  <option value="25">25 / page</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Upcoming Important Dates -->
        <div class="row g-4 mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calendar-heart me-2 text-danger"></i>Upcoming Important Dates</h5>
                <a href="/admin/important-dates?token=<%= token %>" class="btn btn-sm btn-outline-primary">View All</a>
              </div>
              <div class="card-body">
                <% if (upcomingDates.length === 0) { %>
                <div class="text-center text-muted py-4">
                  <i class="bi bi-calendar-check fs-1"></i>
                  <p class="mt-2">No upcoming dates</p>
                </div>
                <% } else { %>
                <div class="row g-3">
                  <% upcomingDates.forEach(date => {
                    const daysUntil = Math.ceil((new Date(date.date) - new Date()) / (1000 * 60 * 60 * 24));
                    const isUrgent = daysUntil <= 7;
                  %>
                  <div class="col-md-4">
                    <div class="card border-<%= isUrgent ? 'danger' : 'secondary' %> <%= isUrgent ? 'border-2' : '' %>">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1"><%= date.title %></h6>
                            <small class="text-muted"><%= date.person || date.dateType %></small>
                          </div>
                          <span class="badge bg-<%= isUrgent ? 'danger' : 'secondary' %>">
                            <% if (daysUntil === 0) { %>TODAY!
                            <% } else if (daysUntil === 1) { %>Tomorrow
                            <% } else { %><%= daysUntil %> days
                            <% } %>
                          </span>
                        </div>
                        <div class="mt-2">
                          <small class="text-muted"><i class="bi bi-calendar3 me-1"></i><%= new Date(date.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %></small>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% }) %>
                </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Completed Sessions -->
        <div class="card">
          <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Recent Completed Sessions</h5>
            <a href="/admin/sessions?status=completed&token=<%= token %>" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
          <div class="card-body p-0">
            <% if (recentCompleted.length === 0) { %>
            <div class="text-center text-muted py-5">
              <i class="bi bi-calendar-check fs-1"></i>
              <p class="mt-2">No completed sessions yet</p>
            </div>
            <% } else { %>
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="selectAll" data-bs-toggle="tooltip" title="Select all">
                  </th>
                  <th>Name</th>
                  <th>Topic</th>
                  <th class="text-center">Score</th>
                  <th>Notes</th>
                  <th>Completed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <% recentCompleted.forEach(session => { %>
                <tr>
                  <td><input type="checkbox" class="form-check-input row-checkbox" data-id="<%= session.id %>"></td>
                  <td>
                    <div class="fw-semibold"><%= session.name %></div>
                    <small class="text-muted"><%= session.email %></small>
                  </td>
                  <td><%= session.topic %></td>
                  <td class="text-center">
                    <% if (session.score) { %>
                    <span class="score-badge bg-<%= session.score >= 8 ? 'success' : session.score >= 6 ? 'warning' : 'danger' %> text-white mx-auto">
                      <%= session.score %>
                    </span>
                    <% } else { %>
                    <span class="text-muted">-</span>
                    <% } %>
                  </td>
                  <td><%= session.notes ? session.notes.substring(0, 50) + (session.notes.length > 50 ? '...' : '') : '-' %></td>
                  <td><%= new Date(session.completedAt).toLocaleDateString() %></td>
                  <td>
                    <a href="/admin/sessions/<%= session.id %>?token=<%= token %>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View details">
                      <i class="bi bi-eye"></i>
                    </a>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
            <% } %>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div class="text-muted small">Showing <span id="showingStart">1</span>-<span id="showingEnd"><%= recentCompleted?.length || 0 %></span> of <span id="totalRows"><%= recentCompleted?.length || 0 %></span></div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
            <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
              <option value="10">10 / page</option>
              <option value="25">25 / page</option>
              <option value="50">50 / page</option>
            </select>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <%- include('_table-controls') %>
  <script>
    const token = '<%= token %>';
    let tableControls;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize table controls for all 3 tables
      // Sessions by Topic - display only, no checkboxes
      const topicTableControls = new TableControls({
        tableBodyId: 'topicTableBody',
        paginationId: 'topicPagination',
        pageSizeId: 'topicPageSize',
        showingStartId: 'topicShowingStart',
        showingEndId: 'topicShowingEnd',
        totalRowsId: 'topicTotalRows',
        hasCheckboxes: false
      });

      // Top Performance Sessions - display only, no checkboxes
      const performersTableControls = new TableControls({
        tableBodyId: 'topPerformersBody',
        paginationId: 'performersPagination',
        pageSizeId: 'performersPageSize',
        showingStartId: 'performersShowingStart',
        showingEndId: 'performersShowingEnd',
        totalRowsId: 'performersTotalRows',
        hasCheckboxes: false
      });

      // Recent Completed Sessions - has checkboxes
      tableControls = new TableControls();
      initCharts();
    });

    function changeDateRange(days) {
      window.location.href = `/admin/analytics?days=${days}&token=${token}`;
    }

    function initCharts() {
      // Status Chart
      const statusData = <%- JSON.stringify(byStatus) %>;
      const statusLabels = Object.keys(statusData).map(k => k.charAt(0).toUpperCase() + k.slice(1));
      const statusValues = Object.values(statusData);
      const statusColors = {
        'Completed': '#198754',
        'Scheduled': '#0d6efd',
        'In_progress': '#ffc107',
        'Cancelled': '#dc3545',
      };

      if (statusLabels.length > 0) {
        new Chart(document.getElementById('statusChart'), {
          type: 'doughnut',
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusValues,
              backgroundColor: statusLabels.map(l => statusColors[l] || '#6c757d'),
              borderWidth: 0,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right' },
            }
          }
        });
      }

      // Chores Chart
      const choreStats = {
        completed: <%= choreStats.completed %>,
        pending: <%= choreStats.pending %>,
        overdue: <%= choreStats.overdue %>
      };

      new Chart(document.getElementById('choresChart'), {
        type: 'bar',
        data: {
          labels: ['Completed', 'Pending', 'Overdue'],
          datasets: [{
            label: 'Chores',
            data: [choreStats.completed, choreStats.pending, choreStats.overdue],
            backgroundColor: ['#198754', '#ffc107', '#dc3545'],
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }
  </script>
</body>
</html>
