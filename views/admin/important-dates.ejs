<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Important Dates - Nagging Wife AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; max-height: 100vh; overflow-y: auto; background: #1e3a5f; position: sticky; top: 0; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .bulk-actions { display: none; background: #e3f2fd; padding: 0.75rem 1rem; border-radius: 8px; align-items: center; gap: 0.5rem; }
    .bulk-actions.show { display: flex; }
    .row-checkbox { cursor: pointer; width: 18px; height: 18px; }
    tr.selected { background-color: #cfe2ff !important; }
    tr.selected td { background-color: #cfe2ff !important; }
    tbody tr:hover { background-color: #f8f9fa; }
    tbody tr.selected:hover { background-color: #b6d4fe !important; }
    .date-type-badge { font-size: 0.75rem; }
    .upcoming-soon { background-color: #fff3cd !important; }
    .overdue { background-color: #f8d7da !important; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'important-dates' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-calendar-heart text-danger me-2"></i>Important Dates</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDateModal">
            <i class="bi bi-plus-lg"></i> Add Date
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-danger text-white">
              <div class="card-body">
                <h6><i class="bi bi-exclamation-circle"></i> Upcoming (7 days)</h6>
                <h3 class="mb-0"><%= upcomingCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <h6><i class="bi bi-cake"></i> Birthdays</h6>
                <h3 class="mb-0"><%= birthdayCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body">
                <h6><i class="bi bi-heart"></i> Anniversaries</h6>
                <h3 class="mb-0"><%= anniversaryCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body">
                <h6><i class="bi bi-calendar-event"></i> Total Dates</h6>
                <h3 class="mb-0"><%= totalDates || 0 %></h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions mb-3" id="bulkActions">
          <span class="me-3"><strong id="selectedCount">0</strong> selected</span>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()" data-bs-toggle="tooltip" title="Delete selected dates">
            <i class="bi bi-trash"></i> Delete Selected
          </button>
        </div>

        <div class="card">
          <div class="card-body p-0">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="selectAll" data-bs-toggle="tooltip" title="Select all">
                  </th>
                  <th>Title</th>
                  <th>Person</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Days Until</th>
                  <th>Reminder</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <% if (dates && dates.length > 0) { %>
                  <% dates.forEach(date => {
                    const today = new Date();
                    const eventDate = new Date(date.date);
                    const thisYearDate = new Date(today.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                    if (thisYearDate < today) thisYearDate.setFullYear(thisYearDate.getFullYear() + 1);
                    const daysUntil = Math.ceil((thisYearDate - today) / (1000 * 60 * 60 * 24));
                    const isUpcoming = daysUntil <= 7 && daysUntil >= 0;
                  %>
                  <tr class="<%= isUpcoming ? 'upcoming-soon' : '' %>">
                    <td><input type="checkbox" class="form-check-input row-checkbox" data-id="<%= date.id %>"></td>
                    <td><strong><%= date.title %></strong></td>
                    <td><%= date.person || '-' %></td>
                    <td>
                      <span class="badge date-type-badge bg-<%= date.dateType === 'birthday' ? 'primary' : date.dateType === 'anniversary' ? 'danger' : date.dateType === 'holiday' ? 'success' : 'secondary' %>">
                        <i class="bi bi-<%= date.dateType === 'birthday' ? 'cake' : date.dateType === 'anniversary' ? 'heart' : date.dateType === 'holiday' ? 'tree' : 'calendar' %>"></i>
                        <%= date.dateType.charAt(0).toUpperCase() + date.dateType.slice(1) %>
                      </span>
                    </td>
                    <td><%= new Date(date.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></td>
                    <td>
                      <% if (daysUntil === 0) { %>
                        <span class="badge bg-danger">Today!</span>
                      <% } else if (daysUntil <= 7) { %>
                        <span class="badge bg-warning text-dark"><%= daysUntil %> days</span>
                      <% } else { %>
                        <span class="text-muted"><%= daysUntil %> days</span>
                      <% } %>
                    </td>
                    <td><%= date.reminderDays %> days before</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick="editDate('<%= date.id %>')" data-bs-toggle="tooltip" title="Edit date">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-success" onclick="viewGiftIdeas('<%= date.id %>')" data-bs-toggle="tooltip" title="View gift ideas">
                        <i class="bi bi-gift"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteDate('<%= date.id %>')" data-bs-toggle="tooltip" title="Delete date">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <% }) %>
                <% } else { %>
                <tr>
                  <td colspan="8" class="text-center py-5">
                    <i class="bi bi-calendar-heart text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No Important Dates Yet</h5>
                    <p class="text-muted">Add birthdays, anniversaries, and other important dates to never forget!</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDateModal">
                      <i class="bi bi-plus-lg"></i> Add Your First Date
                    </button>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div class="text-muted small">Showing <span id="showingStart">1</span>-<span id="showingEnd"><%= dates?.length || 0 %></span> of <span id="totalRows"><%= dates?.length || 0 %></span></div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
            <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
              <option value="10">10 / page</option>
              <option value="25">25 / page</option>
              <option value="50">50 / page</option>
            </select>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Date Modal -->
  <div class="modal fade" id="addDateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Add Important Date</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addDateForm">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="title" placeholder="e.g., Wife's Birthday" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Person</label>
                <input type="text" class="form-control" name="person" placeholder="e.g., Wife, Mom, Dad">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Date Type</label>
                <select class="form-select" name="dateType">
                  <option value="birthday">Birthday</option>
                  <option value="anniversary">Anniversary</option>
                  <option value="holiday">Holiday</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" name="date" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Remind Days Before</label>
                <select class="form-select" name="reminderDays">
                  <option value="1">1 day</option>
                  <option value="3">3 days</option>
                  <option value="7" selected>7 days</option>
                  <option value="14">14 days</option>
                  <option value="30">30 days</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" rows="2" placeholder="Any special notes or gift ideas..."></textarea>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="recurring" id="recurringCheck" checked>
              <label class="form-check-label" for="recurringCheck">
                Recurring (repeats every year)
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Save Date</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Date Modal -->
  <div class="modal fade" id="editDateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Important Date</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editDateForm">
          <input type="hidden" name="id" id="editDateId">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="title" id="editTitle" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Person</label>
                <input type="text" class="form-control" name="person" id="editPerson">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Date Type</label>
                <select class="form-select" name="dateType" id="editDateType">
                  <option value="birthday">Birthday</option>
                  <option value="anniversary">Anniversary</option>
                  <option value="holiday">Holiday</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" name="date" id="editDate" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Remind Days Before</label>
                <select class="form-select" name="reminderDays" id="editReminderDays">
                  <option value="1">1 day</option>
                  <option value="3">3 days</option>
                  <option value="7">7 days</option>
                  <option value="14">14 days</option>
                  <option value="30">30 days</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" id="editNotes" rows="2"></textarea>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="recurring" id="editRecurringCheck">
              <label class="form-check-label" for="editRecurringCheck">
                Recurring (repeats every year)
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Update Date</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <%- include('_table-controls') %>
  <script>
    const token = '<%= token %>';
    let tableControls;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize table controls with pagination and selection
      tableControls = new TableControls();

      document.getElementById('addDateForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.recurring = document.getElementById('recurringCheck').checked;

        try {
          const res = await fetch(`/admin/important-dates?token=${token}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            location.reload();
          } else {
            alert('Failed to save date');
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });
    });

    function getSelectedIds() {
      return tableControls ? tableControls.getSelectedIds() : [];
    }

    async function deleteSelected() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      if (!confirm(`Delete ${ids.length} date(s)?`)) return;

      try {
        const res = await fetch(`/admin/important-dates/bulk-delete?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if (res.ok) location.reload();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteDate(id) {
      if (!confirm('Delete this date?')) return;
      try {
        const res = await fetch(`/admin/important-dates/${id}?token=${token}`, { method: 'DELETE' });
        if (res.ok) location.reload();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function editDate(id) {
      try {
        const res = await fetch(`/admin/important-dates/${id}/edit?token=${token}`);
        const data = await res.json();
        if (data.success && data.date) {
          const d = data.date;
          document.getElementById('editDateId').value = d.id;
          document.getElementById('editTitle').value = d.title || '';
          document.getElementById('editPerson').value = d.person || '';
          document.getElementById('editDateType').value = d.dateType || 'birthday';
          document.getElementById('editDate').value = d.date ? d.date.split('T')[0] : '';
          document.getElementById('editReminderDays').value = d.reminderDays || 7;
          document.getElementById('editNotes').value = d.notes || '';
          document.getElementById('editRecurringCheck').checked = d.recurring || false;
          new bootstrap.Modal(document.getElementById('editDateModal')).show();
        } else {
          alert('Failed to load date');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    document.getElementById('editDateForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editDateId').value;
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      data.recurring = document.getElementById('editRecurringCheck').checked;

      try {
        const res = await fetch(`/admin/important-dates/${id}?token=${token}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          location.reload();
        } else {
          alert('Failed to update date');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    function viewGiftIdeas(id) {
      window.location.href = `/admin/important-dates/${id}/gifts?token=${token}`;
    }
  </script>
</body>
</html>
