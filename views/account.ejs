<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Settings - Nagging Wife AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #9333ea;
      --secondary-color: #7c3aed;
      --accent-color: #e91e63;
    }
    body { background: #f8f9fa; min-height: 100vh; }
    .top-navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 0.75rem 0;
    }
    .navbar-brand {
      font-weight: 700;
      color: var(--primary-color) !important;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .navbar-brand i { color: var(--accent-color); }
    .nav-tabs .nav-link {
      color: #555;
      font-weight: 500;
      border: none;
      padding: 1rem 1.5rem;
    }
    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      background: transparent;
    }
    .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 12px; }
    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      border-radius: 12px 12px 0 0 !important;
      padding: 1rem 1.5rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      border: none;
    }
    .btn-primary:hover { opacity: 0.9; }
    .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="top-navbar">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="<%= basePath %>/">
          <i class="bi bi-heart-fill"></i> Nagging Wife AI
        </a>
        <div class="d-flex align-items-center gap-3">
          <a href="<%= basePath %>/chat?token=<%= token %>" class="btn btn-outline-primary">
            <i class="bi bi-chat-heart me-1"></i> Back to Chat
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="mb-4">
      <h4 class="mb-1">Account Settings</h4>
      <p class="text-muted mb-0">Manage your account, payment methods, and preferences</p>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#security" type="button">
          <i class="bi bi-shield-lock me-2"></i>Login & Security
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payment" type="button">
          <i class="bi bi-credit-card me-2"></i>Payment Options
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notifications" type="button">
          <i class="bi bi-bell me-2"></i>Notifications
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#devices" type="button">
          <i class="bi bi-laptop me-2"></i>Your Devices
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Login & Security Tab -->
      <div class="tab-pane fade show active" id="security" role="tabpanel">
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person me-2"></i>Personal Information</h5>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                  <div>
                    <strong>Name</strong>
                    <div class="text-muted"><%= user.name %></div>
                  </div>
                  <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editNameModal">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                </div>
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                  <div>
                    <strong>Email</strong>
                    <div class="text-muted"><%= user.email %></div>
                  </div>
                  <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editEmailModal">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                </div>
                <div class="d-flex justify-content-between align-items-center py-3">
                  <div>
                    <strong>Phone</strong>
                    <div class="text-muted"><%= user.phone || 'Not set' %></div>
                  </div>
                  <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editPhoneModal">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lock me-2"></i>Password</h5>
              </div>
              <div class="card-body">
                <p class="text-muted">For security, change your password regularly.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                  <i class="bi bi-key me-2"></i>Change Password
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Options Tab -->
      <div class="tab-pane fade" id="payment" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment Methods</h5>
            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addCardModal">
              <i class="bi bi-plus-lg me-1"></i>Add Card
            </button>
          </div>
          <div class="card-body">
            <% if (paymentMethods && paymentMethods.length > 0) { %>
              <% paymentMethods.forEach(pm => { %>
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-credit-card-2-front fs-3 me-3 text-primary"></i>
                    <div>
                      <strong><%= pm.cardType %> ending in <%= pm.cardLast4 %></strong>
                      <% if (pm.isDefault) { %><span class="badge bg-success ms-2">Default</span><% } %>
                      <div class="text-muted small">Expires <%= pm.expiryMonth %>/<%= pm.expiryYear %></div>
                    </div>
                  </div>
                  <div>
                    <% if (!pm.isDefault) { %>
                      <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDefaultCard('<%= pm.id %>')">Set Default</button>
                    <% } %>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCard('<%= pm.id %>')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="text-center text-muted py-4">
                <i class="bi bi-credit-card fs-1 d-block mb-2"></i>
                No payment methods saved<br>
                <small>Add a card to enable subscriptions</small>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Notifications Tab -->
      <div class="tab-pane fade" id="notifications" role="tabpanel">
        <form id="notificationsForm">
          <div class="row g-4">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-calendar-heart me-2"></i>Important Dates</h5>
                </div>
                <div class="card-body">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="importantDatesEmail" name="importantDatesEmail" <%= notificationPrefs?.importantDatesEmail !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="importantDatesEmail">Email reminders</label>
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="importantDatesSms" name="importantDatesSms" <%= notificationPrefs?.importantDatesSms ? 'checked' : '' %>>
                    <label class="form-check-label" for="importantDatesSms">SMS reminders</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="importantDatesPush" name="importantDatesPush" <%= notificationPrefs?.importantDatesPush !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="importantDatesPush">Push notifications</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Chores & Honey-Do's</h5>
                </div>
                <div class="card-body">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="choresEmail" name="choresEmail" <%= notificationPrefs?.choresEmail !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="choresEmail">Email reminders</label>
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="choresSms" name="choresSms" <%= notificationPrefs?.choresSms ? 'checked' : '' %>>
                    <label class="form-check-label" for="choresSms">SMS reminders</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="choresPush" name="choresPush" <%= notificationPrefs?.choresPush !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="choresPush">Push notifications</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>Security Alerts</h5>
                </div>
                <div class="card-body">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="securityEmail" name="securityEmail" <%= notificationPrefs?.securityEmail !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="securityEmail">Email alerts</label>
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="securitySms" name="securitySms" <%= notificationPrefs?.securitySms !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="securitySms">SMS alerts</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="securityPush" name="securityPush" <%= notificationPrefs?.securityPush !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="securityPush">Push notifications</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-2"></i>Save Preferences
            </button>
          </div>
        </form>
      </div>

      <!-- Devices Tab -->
      <div class="tab-pane fade" id="devices" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-laptop me-2"></i>Your Devices</h5>
            <button class="btn btn-outline-light btn-sm" onclick="signOutAllDevices()">
              <i class="bi bi-box-arrow-right me-1"></i>Sign out all other devices
            </button>
          </div>
          <div class="card-body">
            <% if (devices && devices.length > 0) { %>
              <% devices.forEach(device => { %>
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-<%= device.deviceType === 'mobile' ? 'phone' : device.deviceType === 'tablet' ? 'tablet' : 'laptop' %> fs-3 me-3 text-primary"></i>
                    <div>
                      <strong><%= device.deviceName || (device.browser + ' on ' + device.osName) %></strong>
                      <% if (device.isCurrent) { %><span class="badge bg-success ms-2">Current Device</span><% } %>
                      <div class="text-muted small">Last seen: <%= new Date(device.lastSeenAt).toLocaleString() %></div>
                    </div>
                  </div>
                  <% if (!device.isCurrent) { %>
                    <button class="btn btn-outline-danger btn-sm" onclick="signOutDevice('<%= device.id %>')">
                      <i class="bi bi-box-arrow-right me-1"></i>Sign out
                    </button>
                  <% } %>
                </div>
              <% }) %>
            <% } else { %>
              <div class="text-center text-muted py-4">
                <i class="bi bi-laptop fs-1 d-block mb-2"></i>
                No device information available
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="editNameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #9333ea 0%, #e91e63 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-person me-2"></i>Edit Name</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="editNameForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" name="name" value="<%= user.name %>" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editEmailModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #9333ea 0%, #e91e63 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-envelope me-2"></i>Edit Email</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="editEmailForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">New Email</label>
              <input type="email" class="form-control" name="email" value="<%= user.email %>" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" class="form-control" name="currentPassword" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Email</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editPhoneModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #9333ea 0%, #e91e63 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-telephone me-2"></i>Edit Phone</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="editPhoneForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Phone Number</label>
              <input type="tel" class="form-control" name="phone" value="<%= user.phone || '' %>" placeholder="+1 (555) 123-4567">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Phone</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #9333ea 0%, #e91e63 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-key me-2"></i>Change Password</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="changePasswordForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" class="form-control" name="currentPassword" required>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" class="form-control" name="newPassword" required minlength="8">
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-control" name="confirmPassword" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Change Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addCardModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #9333ea 0%, #e91e63 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Add Payment Method</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="addCardForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Card Number</label>
              <input type="text" class="form-control" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
            </div>
            <div class="row g-3">
              <div class="col-4">
                <label class="form-label">Month</label>
                <select class="form-select" name="expiryMonth" required>
                  <% for (let m = 1; m <= 12; m++) { %>
                    <option value="<%= m %>"><%= String(m).padStart(2, '0') %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label">Year</label>
                <select class="form-select" name="expiryYear" required>
                  <% const currentYear = new Date().getFullYear(); %>
                  <% for (let y = 0; y < 10; y++) { %>
                    <option value="<%= currentYear + y %>"><%= currentYear + y %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label">CVV</label>
                <input type="text" class="form-control" name="cvv" placeholder="123" maxlength="4" required>
              </div>
            </div>
            <div class="mb-3 mt-3">
              <label class="form-label">Cardholder Name</label>
              <input type="text" class="form-control" name="cardHolderName" placeholder="John Doe" required>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="isDefault" id="setDefaultCard">
              <label class="form-check-label" for="setDefaultCard">Set as default</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Card</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const basePath = '<%= basePath %>';
    const token = '<%= token %>';

    // Helper for API calls
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
      };
      if (body) options.body = JSON.stringify(body);
      const res = await fetch(`${basePath}${endpoint}?token=${token}`, options);
      return res.json();
    }

    // Form handlers
    document.getElementById('editNameForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const result = await apiCall('/api/account/name', 'PUT', Object.fromEntries(formData));
      if (result.success) location.reload();
      else alert(result.error || 'Failed to update');
    });

    document.getElementById('editEmailForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const result = await apiCall('/api/account/email', 'PUT', Object.fromEntries(formData));
      if (result.success) location.reload();
      else alert(result.error || 'Failed to update');
    });

    document.getElementById('editPhoneForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const result = await apiCall('/api/account/phone', 'PUT', Object.fromEntries(formData));
      if (result.success) location.reload();
      else alert(result.error || 'Failed to update');
    });

    document.getElementById('changePasswordForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      if (data.newPassword !== data.confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      const result = await apiCall('/api/account/password', 'PUT', data);
      if (result.success) {
        alert('Password changed successfully');
        bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
      } else {
        alert(result.error || 'Failed to change password');
      }
    });

    document.getElementById('addCardForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const result = await apiCall('/api/account/payment-methods', 'POST', {
        ...Object.fromEntries(formData),
        isDefault: formData.get('isDefault') === 'on'
      });
      if (result.success) location.reload();
      else alert(result.error || 'Failed to add card');
    });

    document.getElementById('notificationsForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {};
      ['importantDatesEmail', 'importantDatesSms', 'importantDatesPush',
       'choresEmail', 'choresSms', 'choresPush',
       'securityEmail', 'securitySms', 'securityPush'].forEach(key => {
        data[key] = formData.get(key) === 'on';
      });
      const result = await apiCall('/api/account/notifications', 'PUT', data);
      if (result.success) alert('Preferences saved');
      else alert(result.error || 'Failed to save');
    });

    async function setDefaultCard(cardId) {
      const result = await apiCall(`/api/account/payment-methods/${cardId}/default`, 'PUT');
      if (result.success) location.reload();
      else alert('Failed to set default');
    }

    async function deleteCard(cardId) {
      if (!confirm('Remove this payment method?')) return;
      const result = await apiCall(`/api/account/payment-methods/${cardId}`, 'DELETE');
      if (result.success) location.reload();
      else alert('Failed to remove');
    }

    async function signOutDevice(deviceId) {
      if (!confirm('Sign out from this device?')) return;
      const result = await apiCall(`/api/account/devices/${deviceId}`, 'DELETE');
      if (result.success) location.reload();
      else alert('Failed to sign out');
    }

    async function signOutAllDevices() {
      if (!confirm('Sign out from all other devices?')) return;
      const result = await apiCall('/api/account/devices', 'DELETE');
      if (result.success) location.reload();
      else alert('Failed to sign out');
    }
  </script>
</body>
</html>
